<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Basecoin</title>
    <meta name="description" content="A collection of components that make it easy to build interactive charts with D3.">

    <script src="https://d3fc.io/scripts.js"></script>

    <link rel="icon" type="image/png" href="https://d3fc.io/images/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="https://d3fc.io/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://d3fc.io/images/favicon-96x96.png" sizes="96x96">
    <link rel="stylesheet" href="https://d3fc.io/styles.css" />
    <link rel="canonical" href="https://d3fc.io/examples/basecoin/index.html" />
  </head>
  <body>
    <div class="content">

      <nav class="navbar navbar-inverse">
        <div class="container">
            <div class="navbar-header">
              <a href="https://d3fc.io/"><img class="navbar-logo" alt="d3fc" src="https://d3fc.io/images/logo.svg" /></a>
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav navbar-right">
                <li class=""><a href="https://d3fc.io/components/introduction/getting-started.html">Documentation</a></li>
                <li class=""><a href="https://d3fc.io/components/chart/cartesian.html">Components</a></li>
                <li class=""><a href="https://d3fc.io/components/series/candlestick.html">Financial</a></li>
                <li class="active"><a href="https://d3fc.io/examples">Examples</a></li>
                <li><a href="https://github.com/ScottLogic/d3fc">GitHub</a></li>
              </ul>
            </div>
        </div>
      </nav>

      <div class="container example">
  <div class="row">
    <div class="col-sm-9 col-xs-12">
      <h1>
        Basecoin
      </h1>
      <div class="codepen-link">
  <form action="https://codepen.io/pen/define" method="POST" target="_blank">
    <input type="text" name="data" hidden="true"
      value='{
        "html":"&lt;div id&#x3D;\&quot;viewport\&quot;&gt;\n    &lt;div id&#x3D;\&quot;camera\&quot;&gt;\n        &lt;svg id&#x3D;\&quot;background\&quot; viewbox&#x3D;\&quot;0 0 1024 576\&quot; mask&#x3D;\&quot;url(#mask)\&quot;&gt;\n            &lt;g id&#x3D;\&quot;vertical-lines\&quot;/&gt;\n        &lt;/svg&gt;\n        &lt;svg id&#x3D;\&quot;midground\&quot; viewbox&#x3D;\&quot;0 0 1024 576\&quot;&gt;\n            &lt;defs&gt;\n                &lt;mask id&#x3D;\&quot;mask\&quot;&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;white\&quot;/&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;url(#mask-horizontal-gradient)\&quot;/&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;url(#mask-vertical-gradient)\&quot;/&gt;\n                    &lt;linearGradient id&#x3D;\&quot;mask-horizontal-gradient\&quot; x1&#x3D;\&quot;0\&quot; x2&#x3D;\&quot;1\&quot; y1&#x3D;\&quot;0\&quot; y2&#x3D;\&quot;0\&quot;&gt;\n                        &lt;stop offset&#x3D;\&quot;0%\&quot; stop-opacity&#x3D;\&quot;1\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;30%\&quot; stop-opacity&#x3D;\&quot;0\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;70%\&quot; stop-opacity&#x3D;\&quot;0\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;100%\&quot; stop-opacity&#x3D;\&quot;1\&quot;/&gt;\n                    &lt;/linearGradient&gt;\n                    &lt;linearGradient id&#x3D;\&quot;mask-vertical-gradient\&quot; x1&#x3D;\&quot;0\&quot; x2&#x3D;\&quot;0\&quot; y1&#x3D;\&quot;0\&quot; y2&#x3D;\&quot;1\&quot;&gt;\n                        &lt;stop offset&#x3D;\&quot;0%\&quot; stop-opacity&#x3D;\&quot;1\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;30%\&quot; stop-opacity&#x3D;\&quot;0\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;70%\&quot; stop-opacity&#x3D;\&quot;0\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;100%\&quot; stop-opacity&#x3D;\&quot;1\&quot;/&gt;\n                    &lt;/linearGradient&gt;\n                &lt;/mask&gt;\n                &lt;filter id&#x3D;\&quot;blur\&quot; x&#x3D;\&quot;0%\&quot; y&#x3D;\&quot;0%\&quot; width&#x3D;\&quot;30%\&quot; height&#x3D;\&quot;100%\&quot;&gt;\n                    &lt;feImage xlink:href&#x3D;\&quot;#series\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; result&#x3D;\&quot;image\&quot;/&gt;\n                    &lt;feGaussianBlur in&#x3D;\&quot;image\&quot; stdDeviation&#x3D;\&quot;5\&quot;/&gt;\n                &lt;/filter&gt;\n                &lt;mask id&#x3D;\&quot;blur-mask\&quot; x&#x3D;\&quot;0%\&quot; y&#x3D;\&quot;0%\&quot; width&#x3D;\&quot;30%\&quot; height&#x3D;\&quot;100%\&quot;&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;url(#blur-mask-gradient)\&quot;/&gt;\n                    &lt;linearGradient id&#x3D;\&quot;blur-mask-gradient\&quot; x1&#x3D;\&quot;0\&quot; x2&#x3D;\&quot;1\&quot; y1&#x3D;\&quot;0\&quot; y2&#x3D;\&quot;0\&quot;&gt;\n                        &lt;stop offset&#x3D;\&quot;0%\&quot; stop-color&#x3D;\&quot;white\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;30%\&quot; stop-color&#x3D;\&quot;black\&quot;/&gt;\n                    &lt;/linearGradient&gt;\n                &lt;/mask&gt;\n                &lt;mask id&#x3D;\&quot;inverted-blur-mask\&quot; x&#x3D;\&quot;0%\&quot; y&#x3D;\&quot;0%\&quot; width&#x3D;\&quot;100%\&quot; height&#x3D;\&quot;100%\&quot;&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;url(#inverted-blur-mask-gradient)\&quot;/&gt;\n                    &lt;linearGradient id&#x3D;\&quot;inverted-blur-mask-gradient\&quot; x1&#x3D;\&quot;0\&quot; x2&#x3D;\&quot;1\&quot; y1&#x3D;\&quot;0\&quot; y2&#x3D;\&quot;0\&quot;&gt;\n                        &lt;stop offset&#x3D;\&quot;0%\&quot; stop-color&#x3D;\&quot;black\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;30%\&quot; stop-color&#x3D;\&quot;white\&quot;/&gt;\n                    &lt;/linearGradient&gt;\n                &lt;/mask&gt;\n                &lt;filter id&#x3D;\&quot;flare\&quot; x&#x3D;\&quot;40%\&quot; y&#x3D;\&quot;30%\&quot; width&#x3D;\&quot;11%\&quot; height&#x3D;\&quot;40%\&quot;&gt;\n                    &lt;feImage xlink:href&#x3D;\&quot;#series\&quot; x&#x3D;\&quot;0\&quot; y&#x3D;\&quot;0\&quot; width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; result&#x3D;\&quot;image\&quot;/&gt;\n                    &lt;feFlood flood-color&#x3D;\&quot;white\&quot; result&#x3D;\&quot;white-flood\&quot;/&gt;\n                    &lt;feComposite in&#x3D;\&quot;white-flood\&quot; in2&#x3D;\&quot;image\&quot; operator&#x3D;\&quot;atop\&quot; result&#x3D;\&quot;white-image\&quot;/&gt;\n                    &lt;feGaussianBlur in&#x3D;\&quot;white-image\&quot; stdDeviation&#x3D;\&quot;3\&quot; result&#x3D;\&quot;white-blur\&quot;/&gt;\n                    &lt;feColorMatrix type&#x3D;\&quot;saturate\&quot; in&#x3D;\&quot;image\&quot; values&#x3D;\&quot;10\&quot; result&#x3D;\&quot;saturated-image\&quot;/&gt;\n                    &lt;feComposite in&#x3D;\&quot;white-blur\&quot; in2&#x3D;\&quot;saturated-image\&quot; operator&#x3D;\&quot;over\&quot;/&gt;\n                &lt;/filter&gt;\n                &lt;mask id&#x3D;\&quot;flare-mask\&quot; x&#x3D;\&quot;40%\&quot; y&#x3D;\&quot;30%\&quot; width&#x3D;\&quot;11%\&quot; height&#x3D;\&quot;40%\&quot;&gt;\n                    &lt;rect width&#x3D;\&quot;1024\&quot; height&#x3D;\&quot;576\&quot; fill&#x3D;\&quot;url(#flare-mask-gradient)\&quot;/&gt;\n                    &lt;linearGradient id&#x3D;\&quot;flare-mask-gradient\&quot; x1&#x3D;\&quot;0\&quot; x2&#x3D;\&quot;1\&quot; y1&#x3D;\&quot;0\&quot; y2&#x3D;\&quot;0\&quot;&gt;\n                        &lt;stop offset&#x3D;\&quot;40%\&quot; stop-color&#x3D;\&quot;black\&quot;/&gt;\n                        &lt;stop offset&#x3D;\&quot;45%\&quot; stop-color&#x3D;\&quot;white\&quot;/&gt;\n                    &lt;/linearGradient&gt;\n                &lt;/mask&gt;\n            &lt;/defs&gt;\n            &lt;g id&#x3D;\&quot;gridlines\&quot; mask&#x3D;\&quot;url(#mask)\&quot;/&gt;\n            &lt;g mask&#x3D;\&quot;url(#inverted-blur-mask)\&quot;&gt;\n                &lt;g id&#x3D;\&quot;series\&quot;/&gt;\n            &lt;/g&gt;\n            &lt;g filter&#x3D;\&quot;url(#blur)\&quot; mask&#x3D;\&quot;url(#blur-mask)\&quot;/&gt;\n            &lt;g filter&#x3D;\&quot;url(#flare)\&quot; mask&#x3D;\&quot;url(#flare-mask)\&quot;/&gt;\n        &lt;/svg&gt;\n        &lt;svg id&#x3D;\&quot;foreground\&quot; viewbox&#x3D;\&quot;0 0 1024 576\&quot;&gt;\n            &lt;g id&#x3D;\&quot;labels\&quot; mask&#x3D;\&quot;url(#mask)\&quot;/&gt;\n        &lt;/svg&gt;\n    &lt;/div&gt;\n&lt;/div&gt;\n",
        "js": "(function(d3, fc) {\n    \"use strict\";\n\n    // SVG viewbox constants\n    var WIDTH = 1024, HEIGHT = 576;\n\n    // Obviously you should use ES6 modules and mutiple files for this. I\"m\n    // trying to keep the example as simple (and copy/paste-able) as possible.\n    var basecoin = {};\n\n    basecoin.verticalLines = function() {\n\n        return function(selection) {\n\n            selection.each(function(data) {\n\n                var xScale = d3.time.scale()\n                    .domain(data.xDomain)\n                    // Use the full width\n                    .range([0, WIDTH]);\n\n                // Use the simplest scale we can get away with\n                var yScale = d3.scale.linear()\n                    // Define an arbitrary domain\n                    .domain([0, 1])\n                    // Use the full height\n                    .range([HEIGHT, 0]);\n\n                var line = fc.annotation.line()\n                    .value(function(d) { return d.date; })\n                    .orient(\"vertical\")\n                    .xScale(xScale)\n                    .yScale(yScale);\n\n                d3.select(this)\n                    .datum(data)\n                    .call(line);\n            });\n        };\n    };\n\n    basecoin.gridlines = function() {\n\n        return function(selection) {\n\n            selection.each(function(data) {\n\n                // Use the simplest scale we can get away with\n                var xScale = d3.scale.linear()\n                    .domain([data[0].date, data[data.length - 1].date])\n                    // Use the full width\n                    .range([0, WIDTH]);\n\n                // Use the simplest scale we can get away with\n                var yScale = d3.scale.linear()\n                    // Define an arbitrary domain\n                    .domain([0, 1])\n                    // Use the full height\n                    .range([HEIGHT, 0]);\n\n                var gridline = fc.annotation.gridline()\n                    .xScale(xScale)\n                    .yScale(yScale)\n                    .xTicks(40)\n                    .yTicks(20);\n\n                d3.select(this)\n                    .call(gridline);\n            });\n        };\n    };\n\n    basecoin.candlestick = function() {\n\n        var xScale = fc.scale.dateTime(),\n            yScale = d3.scale.linear();\n\n        var candlestick = fc.svg.candlestick()\n            .x(function(d) { return xScale(d.date); })\n            .open(function(d) { return yScale(d.open); })\n            .high(function(d) { return yScale(d.high); })\n            .low(function(d) { return yScale(d.low); })\n            .close(function(d) { return yScale(d.close); })\n            .width(5);\n\n        var upDataJoin = fc.util.dataJoin()\n            .selector(\"path.up\")\n            .element(\"path\")\n            .attr(\"class\", \"up\");\n\n        var downDataJoin = fc.util.dataJoin()\n            .selector(\"path.down\")\n            .element(\"path\")\n            .attr(\"class\", \"down\");\n\n        var optimisedCandlestick = function(selection) {\n            selection.each(function(data) {\n                var upData = data.filter(function(d) { return d.open < d.close; }),\n                    downData = data.filter(function(d) { return d.open >= d.close; });\n\n                upDataJoin(this, [upData])\n                    .attr(\"d\", candlestick);\n\n                downDataJoin(this, [downData])\n                    .attr(\"d\", candlestick);\n            });\n        };\n\n        optimisedCandlestick.xScale = function(x) {\n            if (!arguments.length) {\n                return xScale;\n            }\n            xScale = x;\n            return optimisedCandlestick;\n        };\n        optimisedCandlestick.yScale = function(x) {\n            if (!arguments.length) {\n                return yScale;\n            }\n            yScale = x;\n            return optimisedCandlestick;\n        };\n\n        return optimisedCandlestick;\n    };\n\n    basecoin.series = function() {\n\n        return function(selection) {\n\n            selection.each(function(data) {\n\n                var xScale = d3.time.scale()\n                    .domain([data[0].date, data[data.length - 1].date])\n                    // Modify the range so that the series only takes up left half the width\n                    .range([0, WIDTH * 0.5]);\n\n                var yScale = d3.scale.linear()\n                    .domain(fc.util.extent().fields([\"high\", \"low\"])(data))\n                    // Modify the range so that the series only takes up middle third of the the width\n                    .range([HEIGHT * 0.66, HEIGHT * 0.33]);\n\n                var candlestick = basecoin.candlestick();\n\n                fc.indicator.algorithm.bollingerBands()\n                    // Modify the window size so that we more closely track the data\n                    .windowSize(8)\n                    // Modify the multiplier to narrow the gap between the bands\n                    .multiplier(1)(data);\n\n                fc.indicator.algorithm.exponentialMovingAverage()\n                    // Use a different window size so that the indicators occasionally touch\n                    .windowSize(3)(data);\n\n                var bollingerBands = fc.indicator.renderer.bollingerBands();\n\n                var ema = fc.series.line()\n                    // Reference the value computed by the EMA algorithm\n                    .yValue(function(d) { return d.exponentialMovingAverage; });\n\n                var multi = fc.series.multi()\n                    .xScale(xScale)\n                    .yScale(yScale)\n                    .series([candlestick, bollingerBands, ema])\n                    .decorate(function(g) {\n                        g.enter()\n                            .attr(\"class\", function(d, i) {\n                                return \"multi \" + [\"candlestick\", \"bollinger-bands\", \"ema\"][i];\n                            });\n                    });\n\n                d3.select(this)\n                    .call(multi);\n            });\n        };\n    };\n\n    basecoin.labels = function() {\n\n        return function(selection) {\n\n            selection.each(function(data) {\n\n                var xScale = d3.time.scale()\n                    .domain(data.xDomain)\n                    // Use the full width\n                    .range([0, WIDTH]);\n\n                var yScale = d3.scale.linear()\n                    // Match the output extent of Math.random()\n                    .domain([0, 1])\n                    // Use the full height to amplify the relative spacing of the labels\n                    // (minus the height of the labels themselves)\n                    .range([HEIGHT - 14, 0]);\n\n                var dataJoin = fc.util.dataJoin()\n                    // Join on any g descendents\n                    .selector(\"g\")\n                    // Create any missing as g elements\n                    .element(\"g\")\n                    // Key the nodes on the x value\n                    .key(function(d) { return d.date; });\n\n                var update = dataJoin(this, data);\n\n                var enter = update.enter();\n\n                // Add a path element only when a g first enters the document\n                enter.append(\"path\")\n                    // Pick between a down arrow or an up arrow and colour appropriately\n                    .attr(\"d\", function(d) {\n                        return d.open < d.close ?\n                            \"M 0 14 L 8 0 L 15 14 Z\" : \"M 0 0 L 8 14 L 15 0 Z\";\n                    })\n                    .attr(\"fill\", function(d) {\n                        return d.open < d.close ?\n                            \"green\" : \"red\";\n                    });\n\n                // Add a text element only when a g first enters the document\n                enter.append(\"text\")\n                    .attr({\n                        \"class\": \"label\",\n                        // Offset to avoid the arrow\n                        \"x\": 18,\n                        \"y\": 12\n                    })\n                    .text(function(d) {\n                        return d.close.toFixed(3);\n                    });\n\n                // Position the g on every invocation\n                update.attr(\"transform\", function(d) {\n                    return \"translate(\" + xScale(d.date) + \",\" + yScale(d.offset) + \")\";\n                });\n            });\n        };\n    };\n\n    var dataGenerator = fc.data.random.financial()\n        .mu(0.2)                     // % drift\n        .sigma(0.05)                 // % volatility\n        .filter(fc.util.fn.identity) // don\"t filter weekends\n        .startDate(new Date(2014, 1, 1));\n\n    function enhanceDataItem(d, i, data) {\n        // Mark data points which match the sequence\n        var sequenceValue = (i % (data.length / 2)) / 10;\n        d.highlight = [1, 2, 3, 5, 8].indexOf(sequenceValue) > -1;\n        // Add random offset for labels\n        d.offset = Math.random();\n        return d;\n    }\n\n    var stream = dataGenerator.stream();\n    var _data = stream.take(300)\n        .map(enhanceDataItem);\n\n    var frame = 0;\n\n    var frameTimings = [];\n\n    function render() {\n        frameTimings.push(performance.now());\n\n        var datum = stream.next();\n        datum = enhanceDataItem(datum, _data.length + frame, _data);\n\n        // Roll the data buffer\n        _data.shift();\n        _data.push(datum);\n\n        // Filter to only show vertical lines and labels for the marked data points\n        var highlightedData = _data.filter(function(d) {\n            return d.highlight;\n        });\n        // Scales which receive a subset of the data still it\"s full extent\n        highlightedData.xDomain = [_data[0].date, _data[_data.length - 1].date];\n\n        var verticalLines = basecoin.verticalLines();\n\n        d3.select(\"#vertical-lines\")\n            .datum(highlightedData)\n            .call(verticalLines);\n\n        var gridlines = basecoin.gridlines();\n\n        d3.select(\"#gridlines\")\n            .datum(_data)\n            .call(gridlines);\n\n        var series = basecoin.series();\n\n        d3.select(\"#series\")\n            // Filter to only show the series for the first half of the data\n            .datum(_data.filter(function(d, i) { return i < 150; }))\n            .call(series);\n\n        var labels = basecoin.labels();\n\n        d3.select(\"#labels\")\n            .datum(highlightedData)\n            .call(labels);\n\n        if (frame % 300 === 0) {\n            frameTimings.reduce(function(sum, d, i, arr) {\n                if (i < arr.length - 1) {\n                    sum += arr[i + 1] - d;\n                }\n                return sum;\n            }, 0);\n            frameTimings.length = 0;\n        }\n\n        frame++;\n        requestAnimationFrame(render);\n    }\n\n    render();\n\n})(d3, fc);\n",
        "css": ".chart {\n    margin: 10px 0;\n    width: 100%;\n    height: 250px;\n}\n\n.chart&gt;svg {\n    margin-left: auto;\n    margin-right: auto;\n}\n\n.chart.large {\n    height: 400px;\n}\n#viewport {\n    margin: 20px auto;\n    background: black;\n    overflow: hidden;\n    perspective: 100px;\n    transform-style: preserve-3d;\n}\n\n@keyframes camera-path {\n    from {\n        transform: rotateX(13deg) rotateY(9deg) translate3d(165px, -4px, 26px);\n    }\n    to {\n        transform: rotateX(-1deg) rotateY(8deg) translate3d(165px, -4px, 52px);\n    }\n}\n\n#camera {\n    padding-bottom: 56.25%;\n    transform-style: preserve-3d;\n    animation: camera-path 15s linear 0s infinite alternate;\n}\n\n#background {\n    position: absolute;\n    transform: translateZ(-30px);\n}\n\n#midground {\n    position: absolute;\n}\n\n#foreground {\n    position: absolute;\n    transform: translateZ(20px);\n}\n\n.annotation>line {\n    stroke: rgb(255, 255, 51);\n    stroke-dasharray: 0;\n    stroke-opacity: 0.5;\n}\n\n.gridline {\n    stroke: white;\n    stroke-dasharray: 1, 2;\n}\n\n.candlestick>.up {\n    fill: white;\n    stroke: rgba(77, 175, 74, 1);\n}\n.candlestick>.down {\n    fill: black;\n    stroke: rgba(77, 175, 74, 1);\n}\n\n.bollinger-bands>.area,\n.bollinger-bands>.average {\n    visibility: hidden;\n}\n.bollinger-bands>.upper>path {\n    stroke: rgba(55, 126, 184, 1);\n    stroke-width: 2px;\n}\n.bollinger-bands>.lower>path {\n    stroke: rgba(77, 175, 74, 1);\n    stroke-width: 2px;\n}\n\n.ema>path {\n    stroke: rgba(228, 26, 28, 1);\n    stroke-width: 2px;\n}\n\n.label {\n    stroke: white;\n    text-anchor: initial;\n}\n",
        "js_external": "https://d3fc.io/d3fc.bundle.js",
        "css_external": "https://d3fc.io/d3fc.css"}
      '/>
    <input type="submit" class="btn btn-default" value="Codepen"/>
  </form>
</div>


<style>
#viewport {
    margin: 20px auto;
    background: black;
    overflow: hidden;
    perspective: 100px;
    transform-style: preserve-3d;
}

@keyframes camera-path {
    from {
        transform: rotateX(13deg) rotateY(9deg) translate3d(165px, -4px, 26px);
    }
    to {
        transform: rotateX(-1deg) rotateY(8deg) translate3d(165px, -4px, 52px);
    }
}

#camera {
    padding-bottom: 56.25%;
    transform-style: preserve-3d;
    animation: camera-path 15s linear 0s infinite alternate;
}

#background {
    position: absolute;
    transform: translateZ(-30px);
}

#midground {
    position: absolute;
}

#foreground {
    position: absolute;
    transform: translateZ(20px);
}

.annotation>line {
    stroke: rgb(255, 255, 51);
    stroke-dasharray: 0;
    stroke-opacity: 0.5;
}

.gridline {
    stroke: white;
    stroke-dasharray: 1, 2;
}

.candlestick>.up {
    fill: white;
    stroke: rgba(77, 175, 74, 1);
}
.candlestick>.down {
    fill: black;
    stroke: rgba(77, 175, 74, 1);
}

.bollinger-bands>.area,
.bollinger-bands>.average {
    visibility: hidden;
}
.bollinger-bands>.upper>path {
    stroke: rgba(55, 126, 184, 1);
    stroke-width: 2px;
}
.bollinger-bands>.lower>path {
    stroke: rgba(77, 175, 74, 1);
    stroke-width: 2px;
}

.ema>path {
    stroke: rgba(228, 26, 28, 1);
    stroke-width: 2px;
}

.label {
    stroke: white;
    text-anchor: initial;
}

</style>

<div id="viewport">
    <div id="camera">
        <svg id="background" viewbox="0 0 1024 576" mask="url(#mask)">
            <g id="vertical-lines"/>
        </svg>
        <svg id="midground" viewbox="0 0 1024 576">
            <defs>
                <mask id="mask">
                    <rect width="1024" height="576" fill="white"/>
                    <rect width="1024" height="576" fill="url(#mask-horizontal-gradient)"/>
                    <rect width="1024" height="576" fill="url(#mask-vertical-gradient)"/>
                    <linearGradient id="mask-horizontal-gradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0%" stop-opacity="1"/>
                        <stop offset="30%" stop-opacity="0"/>
                        <stop offset="70%" stop-opacity="0"/>
                        <stop offset="100%" stop-opacity="1"/>
                    </linearGradient>
                    <linearGradient id="mask-vertical-gradient" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stop-opacity="1"/>
                        <stop offset="30%" stop-opacity="0"/>
                        <stop offset="70%" stop-opacity="0"/>
                        <stop offset="100%" stop-opacity="1"/>
                    </linearGradient>
                </mask>
                <filter id="blur" x="0%" y="0%" width="30%" height="100%">
                    <feImage xlink:href="#series" x="0" y="0" width="1024" height="576" result="image"/>
                    <feGaussianBlur in="image" stdDeviation="5"/>
                </filter>
                <mask id="blur-mask" x="0%" y="0%" width="30%" height="100%">
                    <rect width="1024" height="576" fill="url(#blur-mask-gradient)"/>
                    <linearGradient id="blur-mask-gradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0%" stop-color="white"/>
                        <stop offset="30%" stop-color="black"/>
                    </linearGradient>
                </mask>
                <mask id="inverted-blur-mask" x="0%" y="0%" width="100%" height="100%">
                    <rect width="1024" height="576" fill="url(#inverted-blur-mask-gradient)"/>
                    <linearGradient id="inverted-blur-mask-gradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="0%" stop-color="black"/>
                        <stop offset="30%" stop-color="white"/>
                    </linearGradient>
                </mask>
                <filter id="flare" x="40%" y="30%" width="11%" height="40%">
                    <feImage xlink:href="#series" x="0" y="0" width="1024" height="576" result="image"/>
                    <feFlood flood-color="white" result="white-flood"/>
                    <feComposite in="white-flood" in2="image" operator="atop" result="white-image"/>
                    <feGaussianBlur in="white-image" stdDeviation="3" result="white-blur"/>
                    <feColorMatrix type="saturate" in="image" values="10" result="saturated-image"/>
                    <feComposite in="white-blur" in2="saturated-image" operator="over"/>
                </filter>
                <mask id="flare-mask" x="40%" y="30%" width="11%" height="40%">
                    <rect width="1024" height="576" fill="url(#flare-mask-gradient)"/>
                    <linearGradient id="flare-mask-gradient" x1="0" x2="1" y1="0" y2="0">
                        <stop offset="40%" stop-color="black"/>
                        <stop offset="45%" stop-color="white"/>
                    </linearGradient>
                </mask>
            </defs>
            <g id="gridlines" mask="url(#mask)"/>
            <g mask="url(#inverted-blur-mask)">
                <g id="series"/>
            </g>
            <g filter="url(#blur)" mask="url(#blur-mask)"/>
            <g filter="url(#flare)" mask="url(#flare-mask)"/>
        </svg>
        <svg id="foreground" viewbox="0 0 1024 576">
            <g id="labels" mask="url(#mask)"/>
        </svg>
    </div>
</div>


<script>
(function(d3, fc) {
    'use strict';

    // SVG viewbox constants
    var WIDTH = 1024, HEIGHT = 576;

    // Obviously you should use ES6 modules and mutiple files for this. I'm
    // trying to keep the example as simple (and copy/paste-able) as possible.
    var basecoin = {};

    basecoin.verticalLines = function() {

        return function(selection) {

            selection.each(function(data) {

                var xScale = d3.time.scale()
                    .domain(data.xDomain)
                    // Use the full width
                    .range([0, WIDTH]);

                // Use the simplest scale we can get away with
                var yScale = d3.scale.linear()
                    // Define an arbitrary domain
                    .domain([0, 1])
                    // Use the full height
                    .range([HEIGHT, 0]);

                var line = fc.annotation.line()
                    .value(function(d) { return d.date; })
                    .orient('vertical')
                    .xScale(xScale)
                    .yScale(yScale);

                d3.select(this)
                    .datum(data)
                    .call(line);
            });
        };
    };

    basecoin.gridlines = function() {

        return function(selection) {

            selection.each(function(data) {

                // Use the simplest scale we can get away with
                var xScale = d3.scale.linear()
                    .domain([data[0].date, data[data.length - 1].date])
                    // Use the full width
                    .range([0, WIDTH]);

                // Use the simplest scale we can get away with
                var yScale = d3.scale.linear()
                    // Define an arbitrary domain
                    .domain([0, 1])
                    // Use the full height
                    .range([HEIGHT, 0]);

                var gridline = fc.annotation.gridline()
                    .xScale(xScale)
                    .yScale(yScale)
                    .xTicks(40)
                    .yTicks(20);

                d3.select(this)
                    .call(gridline);
            });
        };
    };

    basecoin.candlestick = function() {

        var xScale = fc.scale.dateTime(),
            yScale = d3.scale.linear();

        var candlestick = fc.svg.candlestick()
            .x(function(d) { return xScale(d.date); })
            .open(function(d) { return yScale(d.open); })
            .high(function(d) { return yScale(d.high); })
            .low(function(d) { return yScale(d.low); })
            .close(function(d) { return yScale(d.close); })
            .width(5);

        var upDataJoin = fc.util.dataJoin()
            .selector('path.up')
            .element('path')
            .attr('class', 'up');

        var downDataJoin = fc.util.dataJoin()
            .selector('path.down')
            .element('path')
            .attr('class', 'down');

        var optimisedCandlestick = function(selection) {
            selection.each(function(data) {
                var upData = data.filter(function(d) { return d.open < d.close; }),
                    downData = data.filter(function(d) { return d.open >= d.close; });

                upDataJoin(this, [upData])
                    .attr('d', candlestick);

                downDataJoin(this, [downData])
                    .attr('d', candlestick);
            });
        };

        optimisedCandlestick.xScale = function(x) {
            if (!arguments.length) {
                return xScale;
            }
            xScale = x;
            return optimisedCandlestick;
        };
        optimisedCandlestick.yScale = function(x) {
            if (!arguments.length) {
                return yScale;
            }
            yScale = x;
            return optimisedCandlestick;
        };

        return optimisedCandlestick;
    };

    basecoin.series = function() {

        return function(selection) {

            selection.each(function(data) {

                var xScale = d3.time.scale()
                    .domain([data[0].date, data[data.length - 1].date])
                    // Modify the range so that the series only takes up left half the width
                    .range([0, WIDTH * 0.5]);

                var yScale = d3.scale.linear()
                    .domain(fc.util.extent().fields(['high', 'low'])(data))
                    // Modify the range so that the series only takes up middle third of the the width
                    .range([HEIGHT * 0.66, HEIGHT * 0.33]);

                var candlestick = basecoin.candlestick();

                fc.indicator.algorithm.bollingerBands()
                    // Modify the window size so that we more closely track the data
                    .windowSize(8)
                    // Modify the multiplier to narrow the gap between the bands
                    .multiplier(1)(data);

                fc.indicator.algorithm.exponentialMovingAverage()
                    // Use a different window size so that the indicators occasionally touch
                    .windowSize(3)(data);

                var bollingerBands = fc.indicator.renderer.bollingerBands();

                var ema = fc.series.line()
                    // Reference the value computed by the EMA algorithm
                    .yValue(function(d) { return d.exponentialMovingAverage; });

                var multi = fc.series.multi()
                    .xScale(xScale)
                    .yScale(yScale)
                    .series([candlestick, bollingerBands, ema])
                    .decorate(function(g) {
                        g.enter()
                            .attr('class', function(d, i) {
                                return 'multi ' + ['candlestick', 'bollinger-bands', 'ema'][i];
                            });
                    });

                d3.select(this)
                    .call(multi);
            });
        };
    };

    basecoin.labels = function() {

        return function(selection) {

            selection.each(function(data) {

                var xScale = d3.time.scale()
                    .domain(data.xDomain)
                    // Use the full width
                    .range([0, WIDTH]);

                var yScale = d3.scale.linear()
                    // Match the output extent of Math.random()
                    .domain([0, 1])
                    // Use the full height to amplify the relative spacing of the labels
                    // (minus the height of the labels themselves)
                    .range([HEIGHT - 14, 0]);

                var dataJoin = fc.util.dataJoin()
                    // Join on any g descendents
                    .selector('g')
                    // Create any missing as g elements
                    .element('g')
                    // Key the nodes on the x value
                    .key(function(d) { return d.date; });

                var update = dataJoin(this, data);

                var enter = update.enter();

                // Add a path element only when a g first enters the document
                enter.append('path')
                    // Pick between a down arrow or an up arrow and colour appropriately
                    .attr('d', function(d) {
                        return d.open < d.close ?
                            'M 0 14 L 8 0 L 15 14 Z' : 'M 0 0 L 8 14 L 15 0 Z';
                    })
                    .attr('fill', function(d) {
                        return d.open < d.close ?
                            'green' : 'red';
                    });

                // Add a text element only when a g first enters the document
                enter.append('text')
                    .attr({
                        'class': 'label',
                        // Offset to avoid the arrow
                        'x': 18,
                        'y': 12
                    })
                    .text(function(d) {
                        return d.close.toFixed(3);
                    });

                // Position the g on every invocation
                update.attr('transform', function(d) {
                    return 'translate(' + xScale(d.date) + ',' + yScale(d.offset) + ')';
                });
            });
        };
    };

    var dataGenerator = fc.data.random.financial()
        .mu(0.2)                     // % drift
        .sigma(0.05)                 // % volatility
        .filter(fc.util.fn.identity) // don't filter weekends
        .startDate(new Date(2014, 1, 1));

    function enhanceDataItem(d, i, data) {
        // Mark data points which match the sequence
        var sequenceValue = (i % (data.length / 2)) / 10;
        d.highlight = [1, 2, 3, 5, 8].indexOf(sequenceValue) > -1;
        // Add random offset for labels
        d.offset = Math.random();
        return d;
    }

    var stream = dataGenerator.stream();
    var _data = stream.take(300)
        .map(enhanceDataItem);

    var frame = 0;

    var frameTimings = [];

    function render() {
        frameTimings.push(performance.now());

        var datum = stream.next();
        datum = enhanceDataItem(datum, _data.length + frame, _data);

        // Roll the data buffer
        _data.shift();
        _data.push(datum);

        // Filter to only show vertical lines and labels for the marked data points
        var highlightedData = _data.filter(function(d) {
            return d.highlight;
        });
        // Scales which receive a subset of the data still it's full extent
        highlightedData.xDomain = [_data[0].date, _data[_data.length - 1].date];

        var verticalLines = basecoin.verticalLines();

        d3.select('#vertical-lines')
            .datum(highlightedData)
            .call(verticalLines);

        var gridlines = basecoin.gridlines();

        d3.select('#gridlines')
            .datum(_data)
            .call(gridlines);

        var series = basecoin.series();

        d3.select('#series')
            // Filter to only show the series for the first half of the data
            .datum(_data.filter(function(d, i) { return i < 150; }))
            .call(series);

        var labels = basecoin.labels();

        d3.select('#labels')
            .datum(highlightedData)
            .call(labels);

        if (frame % 300 === 0) {
            frameTimings.reduce(function(sum, d, i, arr) {
                if (i < arr.length - 1) {
                    sum += arr[i + 1] - d;
                }
                return sum;
            }, 0);
            frameTimings.length = 0;
        }

        frame++;
        requestAnimationFrame(render);
    }

    render();

})(d3, fc);

</script>



<p>This example shows how d3fc components can be used to recreate an approximation of the background video on the <a href="https://exchange.coinbase.com/">Coinbase exchange</a> homepage.</p>
<p>This example makes use of a number of components, including the data generator, series and indicators. It also mixes in some SVG filter effects and 3D transforms for good measure.</p>
<p>For a detailed overview of how this chart was implemented, pop over to the Scott Logic blog which covers the details <a href="http://blog.scottlogic.com/2015/08/06/an-adventure-in-svg-filter-land.html">in this blog post</a>.</p>

    </div>

    <nav class="col-sm-3 hidden-xs">
      <ul class="nav nav-stacked fixed nav-sidebar">
        <li>
          <h4>Examples</h4>
          <ul class="nav nav-stacked">
                <li class="active">
                  <a href="/examples/basecoin/index.html">Basecoin</a>
                </li>
                <li class="">
                  <a href="/examples/bubble/index.html">Bubble Chart</a>
                </li>
                <li class="">
                  <a href="/examples/low-barrel/index.html">Low Barrel</a>
                </li>
                <li class="">
                  <a href="/examples/scatter/index.html">Scatterplot</a>
                </li>
                <li class="">
                  <a href="/examples/simple/index.html">Line / Area Chart</a>
                </li>
                <li class="">
                  <a href="/examples/stacked/index.html">Stacked Bar</a>
                </li>
                <li class="">
                  <a href="/examples/streaming/index.html">Streaming Chart</a>
                </li>
                <li class="">
                  <a href="/examples/wealth-and-health-of-nations/index.html">The Wealth &amp; Health of Nations</a>
                </li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>

</div>


    </div>
    <footer>
      <div class="container">
        <p class="muted credit text-center">Project supported by <a href="http://www.scottlogic.com">Scott Logic</a>.</p>
        <p class="muted credit text-center">Browser testing provided by <a class="browserstack" href="https://browserstack.com">BrowserStack</a>.</p>
      </div>
    </footer>

  </body>
</html>
